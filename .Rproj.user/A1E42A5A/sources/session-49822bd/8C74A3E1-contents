# 載入所需的套件
library (dplyr)
library (ggplot2)

# 讀取資料
bird_2 <- read.table ("D:/碩士資料庫/碩三上課程/Ocean R/Ocean-R-Final-project/dwca-trait_454-v1.68/measurementorfacts.txt", header = TRUE, sep = "\t", fill = TRUE)

bird_3 <-  read.table ("D:/碩士資料庫/碩三上課程/Ocean R/Ocean-R-Final-project/dwca-trait_454-v1.68/taxon.txt", header = TRUE, sep = "\t", quote = "", fill = TRUE)

# 使用 quote=""： 如果檔案中引號的使用方式不標準，可以嘗試忽略引號，讓 R 自行處理。

# 篩選出在非繁殖季進行同種群聚的的鳥類資料
co_flocks_nbd <- bird_2 %>% 
  filter (measurementType %in% c("Flocks_ConspecificsNonBreedingSeason"))

# 篩選出在非繁殖季沒有領域性的鳥類資料
nt_nbs <- bird_2 %>% 
  filter (measurementType == "Territoriality_NonBreedingSeason" & measurementValue == 0)

# 將居住於人為棲息地（如農田、城市公園等）的鳥類歸類為 "Anthropogenic habitat"。將不居住於上述人為棲息地的鳥類歸類為 "Natural habitat"。
human_habitat <- bird_2 %>% 
  filter (measurementType %in% 
            c("Habitat_DrylandFarming",
              "Habitat_UrbanParks",
              "Habitat_UrbanRuralArea",
              "Habitat_AquaculturePonds",
              "Habitat_SaltExploitationSites",
              "Habitat_PaddyField") & 
            measurementValue == 1) %>% 
  mutate (habitat = "Anthropogenic habitat")

# 在 filter() 中，== 適合用於匹配單一值，而當有多個值需要篩選時，應使用 %in%。%in% 可以有效地一次性檢查一組值。如果直接使用 ==，只會選c()中的第一個值
nonhuman_habitat <- bird_2 %>% 
  filter (grepl ("Habitat", measurementType) 
          & !(measurementType %in% c("Habitat_DrylandFarming",
                                     "Habitat_UrbanParks",                                 
                                     "Habitat_UrbanRuralArea", 
                                     "Habitat_AquaculturePonds", 
                                     "Habitat_SaltExploitationSites",
                                     "Habitat_PaddyField")) & 
            measurementValue == 1) %>% 
  mutate (habitat = "Natural habitat")

sum (co_flock_habitat$majority_habitat == "Anthropogenic habitat")
sum (co_flock_habitat$majority_habitat == "Natural habitat")

# grepl 的使用在這裡是因為需要進行 部分文字匹配，而不是直接篩選一個完整的值。
# 部分匹配的需求： 如果 measurementType 的欄位值是類似於 "Territoriality_NonBreedingSeason" 或 "Diet_NonBreedingSeason" 等，這些值不完全等於 "NonBreedingSeason"。
# measurementvalue? 1 = yes, 0 = no

# id 只出現在人為或非人為環境，之後用一個新欄位叫人為或非人為環境，再合併taxa

# 結合所有棲息地資料，判定每隻鳥的主要棲息地為自然或人為棲息地。
maj_habitat <- 
  rbind (nonhuman_habitat, human_habitat) %>% 
  group_by (id, habitat) %>%
  tally () %>% 
  group_by (id) %>%
  filter (n == max (n) & n != min(n)) %>%
  select (id, majority_habitat = habitat)

# 將群聚行為資料與主要棲息地資料合併，篩選非繁殖季內沒有領域性的鳥類。
co_flock_habitat <- co_flocks_nbd %>%
  inner_join (maj_habitat, by = "id") %>% 
  inner_join(bird_3, by = "id") %>% 
  filter (id %in% nt_nbs$id)

# 用卡方檢定 (Chi-squared Test)比較不同棲息地（自然與人為）的鳥類是否在群聚行為上具有顯著差異。
chisq.test (co_flock_habitat$measurementValue, co_flock_habitat$majority_habitat)

# Pearson's Chi-squared test with Yates' continuity correction
# data:  f_taxa_co_flock_habitat$measurementValue and f_taxa_co_flock_habitat$majority_habitat
# X-squared = 5.6319, df = 1, p-value = 0.01764

# 用費雪檢定 (Fisher's Exact Test)比較不同棲息地（自然與人為）的鳥類是否在群聚行為上具有顯著差異，適用於小樣本的精確檢定。
fisher.test (co_flock_habitat$measurementValue, co_flock_habitat$majority_habitat)

# 廣義線性模型 (GLM)以鳥類的群聚行為（有或無）作為應變數，主要棲息地（自然或人為）作為自變數，進一步檢驗棲息地對群聚行為的影響。
bird_glm <- glm (measurementValue ~ majority_habitat,
                 data = co_flock_habitat, 
                 family = binomial)

summary (bird_glm)

# Call:
  #   glm(formula = measurementValue ~ majority_habitat, family = binomial, 
  #       data = f_taxa_co_flock_habitat)
  # 
  # Coefficients:
  #   Estimate Std. Error z value Pr(>|z|)   
  # (Intercept)                       2.1972     0.7453   2.948   0.0032 **
  #   majority_habitatNatural habitat  -1.7785     0.7600  -2.340   0.0193 * 
  #   ---
  #   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
  # 
  # (Dispersion parameter for binomial family taken to be 1)
  # 
  # Null deviance: 275.09  on 208  degrees of freedom
  # Residual deviance: 266.91  on 207  degrees of freedom
  # AIC: 270.91
  # 
  # Number of Fisher Scoring iterations: 4
  
# 計算不同棲息地和是否有群聚行為（有/無群聚）的組合次數
stacked_data <- co_flock_habitat %>%
  group_by (majority_habitat, measurementValue) %>%
  summarise (count = n ()) %>%
  ungroup ()

# summarise() 創建一個新表在分組資料中，新增一個名為 count 的變數，該變數表示每組數據中的行數。計算四個組別出現次數
# Anthropogenic habitat - 0 (measurementValue of flock)
# Anthropogenic habitat - 1 (measurementValue of flock)
# Natural habitat - 0 (measurementValue of flock)
# Natural habitat - 1 (measurementValue of flock)
# 作用：group_by() 會讓數據保持分組狀態，在某些操作中可能會導致無法處理整體數據（例如新增變數或進一步計算）。使用 ungroup() 後，數據會回到未分組的原始狀態。

# 計算不同棲息地是否有鳥類群聚行為的比例
stacked_data <- stacked_data %>%
  group_by (majority_habitat) %>%
  mutate (percentage = count / sum (count))

# 繪製不同棲息地是否有鳥類群聚行為比例的疊柱狀圖
ggplot(stacked_data, aes(x = majority_habitat, y = percentage, fill = as.factor (measurementValue))) +
  geom_bar(stat = "identity", position = "stack", width = 0.6) +
  scale_fill_manual(values = c("1" = "skyblue", "0" = "lightcoral"),
                    labels = c("1 (Flocking)", "0 (No Flocking)"),
                    name = "Flocking Behavior") +
  labs(title = "Flocking Behavior by Habitat",
       x = "Habitat Type",
       y = "Proportion") +
  scale_y_continuous (limits = c(0, 1.1), breaks = seq (0, 1, 0.2), labels = c("0.00", "0.20", "0.40", "0.60", "0.80", "1.00")) +
  theme_minimal() +
  theme (legend.position = "top",
         panel.grid.minor.y = element_blank (),
         panel.grid.major.x = element_blank (),
         plot.title = element_text (hjust = 0.5, size = 16), # 標題居中
         plot.margin = margin (20, 20, 20, 20),
         axis.title.x = element_text (margin = margin(t = 15), size = 12),
         axis.title.y = element_text (margin = margin(r = 10), size = 12),
         axis.text.x = element_text (size = 12),
         axis.text.y = element_text (size = 12)) +
  annotate ("text", x = 1.5, y = 1.1, label = "*", size = 6, color = "black") +  # 星號
  annotate ("segment", x = 1, xend = 2, y = 1.05, yend = 1.05, color = "black", linewidth = 0.5) + # 添加橫線
  annotate ("text", x = 2, y = 0.1, label = "n = 189", size = 4, color = "black") +
  annotate ("text", x = 1, y = 0.1, label = "n = 20", size = 4, color = "black")

# 圖 1. 棲息地對鳥類群聚行為的影響
# 此圖呈現不同棲息地的鳥類在非繁殖季是否具有群聚行為（flocking behavior）的比例分布，分為居住於人為棲息地 (Anthropogenic habitat) 和自然棲息地 (Natural habitat) 的鳥類。數據以疊柱狀圖表示，每個柱子的顏色分別代表是否具有群聚行為（紅色代表有群聚行為，藍色代表無群聚行為）。下方標示了每種棲息地的樣本數，人為棲息地的鳥類樣本數為 20，自然棲息地的鳥類樣本數為 189。橫跨兩柱的星號表示統計上的顯著差異。

# 結果
# 圖 1 顯示不同棲息地的鳥類在群聚行為上的顯著差異，鳥類在自然棲息地的群聚行為比例顯著高於人為棲息地。根據卡方檢定結果，不同棲息地的鳥類在群聚行為上的差異達到顯著性（χ² = 5.63, df = 1, p = 0.017）。此外，費雪精確檢定進一步確認了這一結果，顯示不同棲息地的鳥類在群聚行為上具有顯著差異（p = 0.007，95% CI: 0.0186–0.743）。廣義線性模型（GLM）分析結果亦支持上述發現，自然棲息地鳥類的群聚行為發生機率顯著高於人為棲息地（估計值 = -1.78，p = 0.019）。

# annotate() 可以添加例如文字("text")、線條("segment")、箭頭("segment")、矩形("rect")

# \newpage or \pagebreak will work

# fill 指顏色填充。as.factor(measurementValue) 將 measurementValue 轉換為類別型變數（factor）。這樣做的目的是告訴 ggplot2，每個 measurementValue 的值（0 或 1）都是一個類別，而不是一個連續的數值。這樣就能夠為不同的類別指定不同的顏色。

# stat = "identity"：
# geom_bar() 默認的統計變換是 stat = "count"，這表示條形的高度會基於每個類別的計數（即該類別出現的次數）。
# 但在堆疊柱狀圖中，我們通常希望條形的高度根據數據中已計算好的具體數值（如比例或總和）來設定。這時我們需要指定 stat = "identity"，告訴 ggplot2 使用數據中已經存在的 Y 值，而不是計算頻數。

# position = "stack"：這表示條形圖的「堆疊」模式。

# scale_fill_manual() 是 ggplot2 中用來控制圖形顏色的函數，尤其是用於類別變數（如因子或字符型變數）的顏色設置。在堆疊柱狀圖或條形圖中，它允許你手動指定每個類別的顏色，並設定顯示在圖例中的標籤。


# Fisher's Exact Test for Count Data
# data:  f_taxa_co_flock_habitat$measurementValue and f_taxa_co_flock_habitat$majority_habitat
# p-value = 0.007447
# alternative hypothesis: true odds ratio is not equal to 1
# 95 percent confidence interval:
#  0.01860881 0.74323565
# sample estimates:
# odds ratio 
#  0.1699566 


# %in% 是 R 語言中用於檢查集合中元素是否存在的運算符，通常用於篩選、比對或匹配資料。

# Flocks_ConspecificsNonBreedingSeason, measuremment value = 0 表示此物種不會在非繁殖季有同種群聚性

# 確認是否有相同數目habimeasurementType# 確認是否有相同數目habitat 的id
# n == max(n)：
# 只保留該 id 中 n 最大值的那一列，也就是每個 id 最常出現的 habitat。

# n != min(n)：
# 排除那些 n 等於最小值的列，這一步的目的是為了避免當 n 最大值和最小值相等時，保留這種 id（通常是 Natural Habitat 和 Anthropogenic Habitat 數量相等的情況）。

# select 只保留欄位
  
# tally() 是 dplyr 套件中的一個函數，它的主要作用是計算每個分組的數量，此數量的欄位名稱會以n表示，所以用n == max (n)

# 假設資料中有一列代表鳥類是否屬於都市環境，以及非繁殖季的群聚行為
# 如果沒有該列，需手動新增或合併其他資料
# 在這裡假設 measurementRemarks 是都市/非都市的標籤，measurementValue 表示群聚行為

# 匯總群聚行為數據
summary_data <- non_breeding_data %>% 
  group_by(measurementRemarks, measurementValue) %>% 
  summarise(count = n()) %>% 
  ungroup()

# 進行卡方檢定以檢測是否有顯著差異
contingency_table <- summary_data %>% 
  pivot_wider(names_from = measurementValue, values_from = count, values_fill = 0) %>% 
  select(-measurementRemarks) %>% 
  as.matrix()

chisq_test <- chisq.test(contingency_table)

# 顯示結果
print(chisq_test)

# 如果適用，也可以用一般化線性模型進行分析
# 假設數據是二元的 (有群聚行為:1, 無群聚行為:0)

# non_breeding_data$grouping_behavior <- as.numeric(non_breeding_data$measurementValue > 0)
# 
# glm_model <- glm(grouping_behavior ~ measurementRemarks, family = binomial, data = non_breeding_data)
# summary(glm_model)
# 
